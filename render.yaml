# DataBot Render Deployment Configuration
# This file defines the services for deploying DataBot on Render

services:
  # =============================================================================
  # MAIN BOT APPLICATION
  # =============================================================================
  - type: worker
    name: databot-bot
    env: python
    plan: starter  # $7/month - 512MB RAM, 0.1 CPU
    buildCommand: pip install -r requirements.txt && python -c "from app.infrastructure.db import init_db; init_db()"
    startCommand: python start.py
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: LOG_LEVEL
        value: INFO
      - key: COMMAND_PREFIX
        value: "!"
      - key: MAX_VIDEOS_PER_USER
        value: "100"
      - key: RATE_LIMIT_REQUESTS
        value: "10"
      - key: RATE_LIMIT_WINDOW
        value: "60"
      - key: CACHE_TTL
        value: "3600"
      - key: DEFAULT_TIMEZONE
        value: "UTC"
      - key: DISCORD_BOT_TOKEN
        sync: false
      - key: YOUTUBE_API_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: databot-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: databot-redis
          property: connectionString
    autoDeploy: true
    branch: main

  # =============================================================================
  # CELERY WORKER FOR BACKGROUND TASKS
  # =============================================================================
  - type: worker
    name: databot-celery
    env: python
    plan: starter  # $7/month - 512MB RAM, 0.1 CPU
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A app.tasks.celery_app worker --loglevel=info --concurrency=2 --max-tasks-per-child=1000
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: LOG_LEVEL
        value: INFO
      - key: YOUTUBE_API_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: databot-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: databot-redis
          property: connectionString
    autoDeploy: true
    branch: main

  # =============================================================================
  # CELERY BEAT SCHEDULER
  # =============================================================================
  - type: worker
    name: databot-scheduler
    env: python
    plan: starter  # $7/month - 512MB RAM, 0.1 CPU
    buildCommand: pip install -r requirements.txt
    startCommand: celery -A app.tasks.celery_app beat --loglevel=info --pidfile=/tmp/celerybeat.pid
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: LOG_LEVEL
        value: INFO
      - key: DATABASE_URL
        fromDatabase:
          name: databot-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: databot-redis
          property: connectionString
    autoDeploy: true
    branch: main

  # =============================================================================
  # REDIS CACHE
  # =============================================================================
  - type: redis
    name: databot-redis
    plan: starter  # $7/month - 256MB RAM, shared CPU
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []  # Allow all IPs for internal service communication

databases:
  # =============================================================================
  # POSTGRESQL DATABASE
  # =============================================================================
  - name: databot-db
    databaseName: databot
    user: databot
    plan: free  # Free tier - 1GB storage, shared CPU

# =============================================================================
# SECRETS (Configure these in Render Dashboard)
# =============================================================================
# The following secrets need to be configured in the Render dashboard:
# 
# 1. DISCORD_BOT_TOKEN: Your Discord bot token
#    - Go to Discord Developer Portal → Your Application → Bot → Token
# 
# 2. YOUTUBE_API_KEY: Your YouTube Data API v3 key
#    - Go to Google Cloud Console → APIs & Services → Credentials
# 
# 3. DATABASE_URL: PostgreSQL connection string (auto-generated)
#    - Format: postgresql://user:password@host:port/database
#    - This will be automatically created when you provision the database
# 
# 4. REDIS_URL: Redis connection string (auto-generated)
#    - Format: redis://host:port/database
#    - This will be automatically created when you provision Redis
#
# =============================================================================
# DEPLOYMENT INSTRUCTIONS
# =============================================================================
# 
# 1. Push this code to GitHub
# 2. Connect your GitHub repository to Render
# 3. Create a new "Blueprint" deployment
# 4. Render will automatically:
#    - Provision PostgreSQL database (free plan)
#    - Use existing Redis cache (starter plan)
#    - Deploy the background worker (bot)
#    - Deploy Celery worker
#    - Deploy Celery beat scheduler
# 5. Configure secrets in Render dashboard
# 6. Your bot will be running as background workers (no HTTP endpoints)
#
# =============================================================================
# COST ESTIMATE
# =============================================================================
# 
# Monthly costs (Render):
# - Background Worker (Bot): $7
# - Celery Worker: $7  
# - Celery Scheduler: $7
# - PostgreSQL Database: $0 (free plan)
# - Redis Cache: $7 (starter plan - cannot downgrade existing)
# 
# Total: ~$28/month for full production deployment with all features
#
# =============================================================================
# FEATURES INCLUDED
# =============================================================================
# 
# ✅ All Discord commands work
# ✅ Video tracking and management
# ✅ User registration and roles
# ✅ Automatic video stats updates
# ✅ Scheduled background tasks
# ✅ Monthly reports generation
# ✅ Automatic video syncing from channels
# ✅ Full database operations
# ✅ Redis caching for performance
#
# =============================================================================
# SCALING OPTIONS
# =============================================================================
# 
# For higher traffic, consider upgrading to:
# - Standard plans ($25/month each) for more CPU/RAM
# - Pro plans ($100/month each) for dedicated resources
# - Scale multiple Celery workers for better performance
